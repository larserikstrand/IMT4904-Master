package no.hig.strand.lars.todoity.services;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.HashMap;
import java.util.List;
import java.util.Map.Entry;

import no.hig.strand.lars.todoity.R;
import no.hig.strand.lars.todoity.SettingsActivity;
import no.hig.strand.lars.todoity.Task;
import no.hig.strand.lars.todoity.TasksDb;
import no.hig.strand.lars.todoity.utils.Utilities;
import android.app.Service;
import android.content.Intent;
import android.content.SharedPreferences;
import android.os.IBinder;
import android.preference.PreferenceManager;

public class RecommenderService extends Service {

	private TasksDb mTasksDb;

	@Override
	public void onCreate() {
		super.onCreate();
		
		mTasksDb = TasksDb.getInstance(this);
	}

	@Override
	public void onDestroy() {
		super.onDestroy();
	}

	@Override
	public int onStartCommand(Intent intent, int flags, int startId) {
		
		
		
		return START_STICKY;
	}
	
	
	
	/*
	 * Calculate the type of task (category) that is completed most often
	 *  at the time of the calculation.
	 */
	private void recommendTimeOfDay() {
		List<String> categories;
		HashMap<String, Integer> categoryOccurrences = 
				new HashMap<String, Integer>();
		ArrayList<Task> tasks = mTasksDb.getTaskHistory();
		
		// Get the categories as a list.
		SharedPreferences sharedPref = PreferenceManager
				.getDefaultSharedPreferences(this);
		String occupationPref = sharedPref.getString(
				SettingsActivity.PREF_OCCUPATION_KEY, "");
		if (occupationPref.equals(getString(R.string.pref_undergraduate))) {
			categories = Arrays.asList(getResources()
					.getStringArray(R.array.undergraduate_tasks_array));
		} else {
			categories = Arrays.asList(getResources()
					.getStringArray(R.array.postgraduate_tasks_array));
		}
		
		// Put the categories in a HashMap. This is used to count occurrences
		//  of what type of tasks happen at what times.
		for (String category : categories) {
			categoryOccurrences.put(category, 0);
		}
		
		// Get current time since midnight.
		long timeNow = Utilities.getTimeOfDay(
				Calendar.getInstance().getTimeInMillis());
		long startTimeTask;
		long endTimeTask;
		for (Task task : tasks) {
			if (task.getTimeStarted() > 0) {
				// Get start and end time since midnight of the task.
				startTimeTask = Utilities.getTimeOfDay(task.getTimeStarted());
				endTimeTask = Utilities.getTimeOfDay(task.getTimeEnded());
				
				if (startTimeTask < timeNow && endTimeTask > timeNow) {
					int occurrences = categoryOccurrences
							.get(task.getCategory()) + 1;
					categoryOccurrences.put(task.getCategory(), occurrences);
				}
			}
		}
		
		Entry<String, Integer> highestOccurrence = null;
		for (Entry<String, Integer> entry : categoryOccurrences.entrySet()) {
			if (highestOccurrence == null || 
					entry.getValue() > highestOccurrence.getValue()) {
				highestOccurrence = entry;
			}
		}
		if (highestOccurrence != null) {
			String categoryToRecommend = highestOccurrence.getKey();
		}
	}
	
	
	
	
	@Override
	public IBinder onBind(Intent intent) {
		// TODO Auto-generated method stub
		return null;
	}
}
